{% extends "base.html" %}

{% block title %}Knowledge Base{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/notes.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
        <!-- Upcoming Notes Banner -->
        {% if upcoming_notes%}
        <div class="news-section flex-grow-1 me-3 p-2">
            <span class="banner-title">Upcoming Notes:</span>
            <div class="scroll-mask">
                <div class="scrolling-content">
                    {% for upcoming in upcoming_notes %}
                    <span class="upcoming-item">{{ upcoming.title }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tag Search Box -->
        <div class="search-box">
            <input type="text" id="tagSearch" class="form-control" placeholder="Search for materials">
        </div>
    </div>
</div>

<div class="container" style="padding: 2rem 1rem;">
    <div class="row justify-content-center">
        {% for note in notes %}
        <div class="col-md-4 col-sm-6 mb-4">
            <div class="note-card" onclick="window.open('{{ note.notion_url }}', '_blank')">
                <div class="note-thumbnail" style="background-image: url('{{ note.thumbnail }}');">
                    <div class="note-overlay">
                        <div class="note-title">{{ note.title }}</div>
                        <div class="note-description">{{ note.description }}</div>
                        <div class="note-tags mt-2">
                            {% for tag in note.tags %}
                            <span class="badge me-1 small" style="background-color:yellow; color:black">{{ tag
                                }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if upcoming_notes%}
<!-- Floating Button (Only visible on Mobile) -->
<div class="show-upcoming-btn d-md-none" data-bs-toggle="modal" data-bs-target="#upcomingModal">ðŸ“¢</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="upcomingModal" tabindex="-1" aria-labelledby="upcomingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: rgba(0, 0, 0, 1); color: white;">
            <div class="modal-header">
                <h5 class="modal-title" id="upcomingModalLabel">ðŸ“¢ Upcoming Notes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group">
                    {% for upcoming in upcoming_notes %}
                    <li class="list-group-item bg-dark text-white border-secondary">{{ upcoming.title }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    document.getElementById("tagSearch").addEventListener("input", function () {
        const searchTerm = this.value.toLowerCase();
        const cards = document.querySelectorAll(".note-card");

        cards.forEach(card => {
            const title = card.querySelector(".note-title").textContent.toLowerCase();
            const tags = Array.from(card.querySelectorAll(".badge")).map(tag => tag.textContent.toLowerCase());
            let match = false;

            // Match if title or any tag contains searchTerm
            if (title.includes(searchTerm) || tags.some(tag => tag.includes(searchTerm))) {
                match = true;
            }

            if (searchTerm.length >= 3) {
                if (match) {
                    card.style.opacity = "1";
                    card.style.transform = "scale(1)";
                    card.style.pointerEvents = "auto";
                    card.style.position = "";
                } else {
                    card.style.opacity = "0";
                    card.style.transform = "scale(0.9)";
                    card.style.pointerEvents = "none";
                    card.style.position = "absolute"; /* removes its space smoothly */
                }
            } else {
                // Reset when search < 3 chars
                card.style.opacity = "1";
                card.style.transform = "scale(1)";
                card.style.pointerEvents = "auto";
                card.style.position = "";
            }
        });
    });
</script>
{% endblock %}